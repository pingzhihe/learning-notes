<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <style>
      :root {
        --content-width: 950px !important;     /* 调整内容区域最大宽度 */
      }
      
      /* 调整主要内容区域的宽度和边距 */
      .theme-default-content {
        max-width: var(--content-width);
        margin: 0 auto;
        padding: 2rem 2.5rem;
      }
    </style><title>智能指针 | Learning Notes</title><meta name="description" content="A note taking web site">
    <link rel="preload" href="/learning-notes/assets/style-CeqOocvs.css" as="style"><link rel="stylesheet" href="/learning-notes/assets/style-CeqOocvs.css">
    <link rel="modulepreload" href="/learning-notes/assets/app-DsOgR8nk.js"><link rel="modulepreload" href="/learning-notes/assets/Smart-pointer.html-CGG3TVYS.js">
    <link rel="prefetch" href="/learning-notes/assets/index.html-DiukWnyu.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-D7rYKWbh.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision-2.html-C1P0zbGW.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision-3.html-H5WRivyx.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision.html-j7uDJZWI.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Enums-Structs.html-B5x4Jgi6.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-CQ8rKHO-.js" as="script"><link rel="prefetch" href="/learning-notes/assets/basic.html-W8JFeAA1.js" as="script"><link rel="prefetch" href="/learning-notes/assets/pointers-2.html-CMWGu_On.js" as="script"><link rel="prefetch" href="/learning-notes/assets/pointers.html-BbZIyEFa.js" as="script"><link rel="prefetch" href="/learning-notes/assets/scope.html-CNsZl0YI.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-DncVXc6Z.js" as="script"><link rel="prefetch" href="/learning-notes/assets/lec.html-Cj2eamcj.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision.html-D9K8lSGg.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-Dj_jYuAM.js" as="script"><link rel="prefetch" href="/learning-notes/assets/commands.html-B2Nlgx6s.js" as="script"><link rel="prefetch" href="/learning-notes/assets/shortkeys.html-Bw1WT07S.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Basic.html-BQqgykgV.js" as="script"><link rel="prefetch" href="/learning-notes/assets/QAOA.html-CXcNTDWT.js" as="script"><link rel="prefetch" href="/learning-notes/assets/QFE.html-uZLoELzv.js" as="script"><link rel="prefetch" href="/learning-notes/assets/QFT.html-nC7_EMuw.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-CycaJi4z.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Teleportation.html-B5xiFHhT.js" as="script"><link rel="prefetch" href="/learning-notes/assets/shor's algotighm.html-CFkOzbw3.js" as="script"><link rel="prefetch" href="/learning-notes/assets/week11.html-BklFsnpI.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Closure.html-Da2fu2X7.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Emun.html-7GwBy-Ku.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Error-handle.html-Dn0oJ09B.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Fearless-concurrency.html-BMfS4r6X.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Life-time.html-O1LlmtO2.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Minigrep.html-CtAynLVu.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Num-type.html-DmsPYGp0.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Ownership.html-BQpY6Wb3.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Package-management.html-Btp44fEp.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-ColOM-Zh.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Struct.html-QbgWDSwd.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Test.html-18qFlW93.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Trait.html-BqHMDhMb.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Vector.html-BsWTR8k7.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Bayesian-inference.html-Cx9f9JxL.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Bayesian.html-DKqLsxtv.js" as="script"><link rel="prefetch" href="/learning-notes/assets/GMM-EM.html-jt6UK2iJ.js" as="script"><link rel="prefetch" href="/learning-notes/assets/Multi-Armed-Bandits.html-CCn_WnvB.js" as="script"><link rel="prefetch" href="/learning-notes/assets/index.html-BYPcUCdL.js" as="script"><link rel="prefetch" href="/learning-notes/assets/ann.html-_F-60DzV.js" as="script"><link rel="prefetch" href="/learning-notes/assets/cross-validation.html-BDU9hBjG.js" as="script"><link rel="prefetch" href="/learning-notes/assets/final-revision.html-BEFIYDhE.js" as="script"><link rel="prefetch" href="/learning-notes/assets/gmm-em.html-C-2OJUhS.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision-2.html-Cmf9Gy4X.js" as="script"><link rel="prefetch" href="/learning-notes/assets/revision.html-hB2XmEt4.js" as="script"><link rel="prefetch" href="/learning-notes/assets/svm.html-Div-Hb-t.js" as="script"><link rel="prefetch" href="/learning-notes/assets/week-12.html-DkRXhCon.js" as="script"><link rel="prefetch" href="/learning-notes/assets/404.html-uulsbaPi.js" as="script"><link rel="prefetch" href="/learning-notes/assets/setupDevtools-7MC2TMWH-BtqJD9t-.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/learning-notes/"><!----><span class="vp-site-name" aria-hidden="true">Learning Notes</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/learning-notes/" aria-label="Home"><!---->Home<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/learning-notes/" aria-label="Home"><!---->Home<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/guide/" aria-label="Guide"><!---->Guide<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/guide/shortkeys.html" aria-label="Shortkeys"><!---->Shortkeys<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/guide/commands.html" aria-label="Commands"><!---->Commands<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/CPP/" aria-label="Cpp"><!---->Cpp<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/CPP/basic.html" aria-label="Basic"><!---->Basic<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/CPP/scope.html" aria-label="Scope, Duration, and Linkage"><!---->Scope, Duration, and Linkage<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/CPP/pointers.html" aria-label="Pointers(1)"><!---->Pointers(1)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/CPP/pointers-2.html" aria-label="Pointers(2)"><!---->Pointers(2)<!----></a><!----></li><!--]--></ul></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active collapsible" href="/learning-notes/rust-learning/" aria-label="Rust Learning"><!---->Rust Learning<!----></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Num-type.html" aria-label="1.Number Types"><!---->1.Number Types<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Ownership.html" aria-label="2.Ownership"><!---->2.Ownership<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Struct.html" aria-label="3.Struct"><!---->3.Struct<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Emun.html" aria-label="4.Enum"><!---->4.Enum<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Package-management.html" aria-label="5.Package-management"><!---->5.Package-management<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Vector.html" aria-label="6.Vector"><!---->6.Vector<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Error-handle.html" aria-label="7.Error handle"><!---->7.Error handle<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Trait.html" aria-label="8.Trait  泛型"><!---->8.Trait  泛型<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Life-time.html" aria-label="9.Life time"><!---->9.Life time<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Test.html" aria-label="10.Test"><!---->10.Test<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Minigrep.html" aria-label="11.Minigrep"><!---->11.Minigrep<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Closure.html" aria-label="12.Closure 闭包"><!---->12.Closure 闭包<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/learning-notes/rust-learning/Smart-pointer.html" aria-label="13.Smart pointer 智能指针"><!---->13.Smart pointer 智能指针<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/rust-learning/Fearless-concurrency.html" aria-label="14.Fearless concurrency 无畏并发"><!---->14.Fearless concurrency 无畏并发<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/quantum-computing/" aria-label="Quantum Computing"><!---->Quantum Computing<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/Basic.html" aria-label="Basic computing and quantum computing Theory"><!---->Basic computing and quantum computing Theory<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/Teleportation.html" aria-label="Teleportation"><!---->Teleportation<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/QFT.html" aria-label="QKD and QFT"><!---->QKD and QFT<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/QFE.html" aria-label="QFE and Shor&#39;s algorithm"><!---->QFE and Shor&#39;s algorithm<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/QAOA.html" aria-label="QAOA"><!---->QAOA<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/shor&#39;s%20algotighm.html" aria-label="Quantum algorithms"><!---->Quantum algorithms<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/quantum-computing/week11.html" aria-label="Week 11"><!---->Week 11<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/stat-machine-learning/" aria-label="Statical Machine Learning"><!---->Statical Machine Learning<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/Bayesian.html" aria-label="Bayesian Linear Regression"><!---->Bayesian Linear Regression<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/revision.html" aria-label="Linear regression and logistic regresion"><!---->Linear regression and logistic regresion<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/revision-2.html" aria-label="Bais"><!---->Bais<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/svm.html" aria-label="SVM, Kernel Methods"><!---->SVM, Kernel Methods<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/ann.html" aria-label="Precepction and Artificial Neural Network"><!---->Precepction and Artificial Neural Network<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/cross-validation.html" aria-label="Cross validation, experts learning, MAB"><!---->Cross validation, experts learning, MAB<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/Bayesian-inference.html" aria-label="Bayesian inference"><!---->Bayesian inference<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/GMM-EM.html" aria-label="GMM-EM"><!---->GMM-EM<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/stat-machine-learning/final-revision.html" aria-label="final"><!---->final<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/SPM/" aria-label="Software Project Management"><!---->Software Project Management<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/SPM/lec.html" aria-label="Lecture"><!---->Lecture<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/SPM/revision.html" aria-label="Revision"><!---->Revision<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/learning-notes/AI-planning/" aria-label="AI-planning"><!---->AI-planning<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/AI-planning/revision.html" aria-label="Classical planning"><!---->Classical planning<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/AI-planning/revision-2.html" aria-label="MDP and reinforcement learning"><!---->MDP and reinforcement learning<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/learning-notes/AI-planning/revision-3.html" aria-label="Game theory and final recap"><!---->Game theory and final recap<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="智能指针" tabindex="-1"><a class="header-anchor" href="#智能指针"><span>智能指针</span></a></h1><ul><li>指针: 一个变量在内存中包含的是一个地址(指向其他数据)</li><li>Rust 中最常见的指针就是&quot;引用&quot;</li><li>引用 <ul><li>使用 <code>&amp;</code></li><li>借用它指向的值</li><li>没有其它开销</li><li>最常见的指针类型</li></ul></li></ul><h2 id="智能指针-1" tabindex="-1"><a class="header-anchor" href="#智能指针-1"><span>智能指针</span></a></h2><ul><li>智能指针是这样一些数据结构: <ul><li>行为和指针相似</li><li>有额外的元数据和功能</li></ul></li></ul><h3 id="引用计数-reference-counting-智能指针类型" tabindex="-1"><a class="header-anchor" href="#引用计数-reference-counting-智能指针类型"><span>引用计数(Reference Counting) 智能指针类型</span></a></h3><ul><li>通过记录所有者的数量, 使一份数据被多个所有者同时持有</li><li>并在没有任何所有者时自动清理数据</li></ul><h3 id="引用和智能指针的其他不同" tabindex="-1"><a class="header-anchor" href="#引用和智能指针的其他不同"><span>引用和智能指针的其他不同</span></a></h3><ul><li>引用: 只借用数据</li><li>智能指针: 很多时候都拥有它所指向的数据</li></ul><h3 id="智能指针的例子" tabindex="-1"><a class="header-anchor" href="#智能指针的例子"><span>智能指针的例子</span></a></h3><ul><li><code>String</code> 和 <code>Vec&lt;T&gt;</code></li><li>都拥有一片内存区域, 且允许用户对其操作</li><li>还拥有元数据(例如容量等)</li><li>提供额外的功能或保障(String 保障其数据是合法的 UTF-8 编码)</li></ul><h3 id="智能指针的实现" tabindex="-1"><a class="header-anchor" href="#智能指针的实现"><span>智能指针的实现</span></a></h3><ul><li>智能指针通常使用struct实现, 并且实现了: <ul><li><code>Deref</code> 和 <code>Drop</code> trait</li></ul></li><li>Deref trait: 允许智能指针struct 实例像引用一样被使用</li><li>Drop trait: 允许我们自定义当智能指针实例离开作用域时运行的代码</li></ul><h2 id="本章内容" tabindex="-1"><a class="header-anchor" href="#本章内容"><span>本章内容</span></a></h2><ul><li><p>介绍标准库中常见的智能指针</p><ul><li><code>Box&lt;T&gt;</code>: 在heap内存上分配值</li><li><code>Rc&lt;T&gt;</code>: 启用多重所有权的引用计数类型</li><li><code>Ref&lt;T&gt;</code> 和 <code>RefMut&lt;T&gt;</code>: 通过 <code>RefCell&lt;T&gt;</code> 访问: 在运行时而不是在编译时强制借用规则的类型</li></ul></li><li><p>此外:</p><ul><li>内部可变模式(Interior mutability pattern): 不可变类型暴露出可修改其内部值的API</li><li>引用循环(Reference cycles): 它们如何泄漏内存, 以及如何防止其发生</li></ul></li></ul><h2 id="使用-box-t-来指向heap上的数据" tabindex="-1"><a class="header-anchor" href="#使用-box-t-来指向heap上的数据"><span>使用 <code>Box&lt;T&gt;</code> 来指向heap上的数据</span></a></h2><h3 id="box-t" tabindex="-1"><a class="header-anchor" href="#box-t"><span><code>Box&lt;T&gt;</code></span></a></h3><ul><li><code>Box&lt;T&gt;</code> 是最简单的智能指针: <ul><li><p>允许你在heap上存储数据(而不是stack)</p></li><li><p>stack 上是指向heap上数据的指针</p></li><li><p>没有性能开销</p></li><li><p>没有其它额外功能</p></li><li><p>实现了 <code>Deref</code> trait 和 <code>Drop</code> trait</p></li></ul></li></ul><h3 id="box-t-的常用场景" tabindex="-1"><a class="header-anchor" href="#box-t-的常用场景"><span><code>Box&lt;T&gt;</code> 的常用场景</span></a></h3><ul><li>在编译时, 其类型的大小无法确定。但使用该类型时, 上下文却需要知道它确切大小</li><li>当你有大量数据, 想移交所有权, 但需要确保在操作时数据不会被复制</li><li>使用某个值时, 你只关心它是否实现了特定的trait, 而不关心它的具体类型</li></ul><h3 id="box-t-在heap上存储数据" tabindex="-1"><a class="header-anchor" href="#box-t-在heap上存储数据"><span><code>Box&lt;T&gt;</code> 在heap上存储数据</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b = {}&quot;</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当离开作用域后,存在stack上的指针和heap上的数据都会被清理</p><h3 id="使用box赋能递归类型" tabindex="-1"><a class="header-anchor" href="#使用box赋能递归类型"><span>使用Box赋能递归类型</span></a></h3><ul><li>在编译时, Rust 需要知道一个类型所占的空间大小</li><li>而递归类型的大小无法在编译的时候被确定</li></ul><img src="/learning-notes/assets/image-1-CxISAVww.png" alt="Recursing" width="300"><ul><li>Rust 无法确定一个递归类型的大小</li><li>但是Box 类型的大小确定</li><li>在递归类型中使用Box, 就可以解决上述问题</li><li>函数式语言中的Cons List</li></ul><h3 id="关于cons-list" tabindex="-1"><a class="header-anchor" href="#关于cons-list"><span>关于Cons List</span></a></h3><ul><li><p>Cons List 是来自Lisp语言的一种数据结构</p></li><li><p>Cons List 里的每个成员由两个元素组成</p><ul><li>当前项的值</li><li>下一个元素</li></ul></li><li><p>Cons List 里的最后一个元素只包含一个Nil 值, 没有下一个元素</p><ul><li>Nil 表示终止标记</li><li>Null 表示无效或者缺失的值</li></ul></li></ul><h3 id="cons-list-并不是rust的常用集合" tabindex="-1"><a class="header-anchor" href="#cons-list-并不是rust的常用集合"><span>Cons List 并不是Rust的常用集合</span></a></h3><ul><li>Rust 中的<code>Vec&lt;T&gt;</code> 是更常用的集合类型</li><li>构建一个Cons List</li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Cons</span> <span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Nil</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>报错: <code> recursive type `List` has infinite size</code></p><ul><li>Rust 无法计算出存储一个List 所需的空间大小</li><li>不是直接存储数据, 而是存储指向数据的指针, 例如 <code>Box&lt;T&gt;</code></li></ul><h3 id="使用box-t-来获得确定大小的递归类型" tabindex="-1"><a class="header-anchor" href="#使用box-t-来获得确定大小的递归类型"><span>使用<code>Box&lt;T&gt;</code> 来获得确定大小的递归类型</span></a></h3><ul><li><code>Box&lt;T&gt;</code> 是一个指针, Rust 知道它需要多少空间, 因为: <ul><li>存储的是一个地址, 指针的大小不会基于它所指向的数据的大小而改变</li></ul></li></ul><img src="/learning-notes/assets/image-2-ChU6pElb.png" alt="Box&lt;T&gt;" width="250"><ul><li><code>Box&lt;T&gt;</code>: <ul><li>只提供了&quot;间接&quot;存储和heap内存分配的功能</li><li>没有其它额外功能</li><li>没有性能开销</li><li>适用于需要&quot;间接&quot;存储的场景, 例如Cons List</li><li>实现了 <code>Deref</code> trait 和 <code>Drop</code> trait</li></ul></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token class-name">Box</span><span class="token punctuation">::</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token class-name">Box</span><span class="token punctuation">::</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Cons</span> <span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Nil</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="deref-trait" tabindex="-1"><a class="header-anchor" href="#deref-trait"><span>Deref Trait</span></a></h2><ul><li>实现了 <code>Deref</code> trait 使我们可以自定义解引用运算符 <code>*</code>的行为</li><li>通过实现 <code>Deref</code>, 智能指针可像常规引用一样来处理</li></ul><h3 id="解引用运算符" tabindex="-1"><a class="header-anchor" href="#解引用运算符"><span>解引用运算符</span></a></h3><ul><li>常规引用是一种指针</li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的y就相当于是一个指针, <code>*y</code> 就是取y这个指针指向的值<br> 如果去掉<code>*</code> 我们: <code> assert_eq!(5,*y);</code> 就会报错<code>no implementation for `{integer} == &amp;{integer}`</code></p><h3 id="把box-t-当作引用" tabindex="-1"><a class="header-anchor" href="#把box-t-当作引用"><span>把<code>Box&lt;T&gt;</code> 当作引用</span></a></h3><ul><li><code>Box&lt;T&gt;</code> 可以代替上例中的引用</li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="定义自己的智能指针" tabindex="-1"><a class="header-anchor" href="#定义自己的智能指针"><span>定义自己的智能指针</span></a></h3><ul><li><code>Box&lt;T&gt;</code> 被定义成拥有一个元素的tuple struct</li><li>(例子) <code>MyBox&lt;T&gt;</code></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token type-definition class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">MyBox</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token class-name">MyBox</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是这里会报错因为没有实现 <code>Deref</code> trait</p><h3 id="实现-deref-trait" tabindex="-1"><a class="header-anchor" href="#实现-deref-trait"><span>实现 <code>Deref</code> trait</span></a></h3><ul><li>标准库中的 <code>Deref</code> trait 要求我们实现一个 <code>deref</code> 方法 <ul><li>该方法借用 <code>self</code></li><li>返回一个指向内部数据的引用</li></ul></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">struct</span> <span class="token type-definition class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">MyBox</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token class-name">MyBox</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="函数方法的隐式解引用转化-deref-coercion" tabindex="-1"><a class="header-anchor" href="#函数方法的隐式解引用转化-deref-coercion"><span>函数方法的隐式解引用转化(Deref coercion)</span></a></h3><ul><li><p>隐式解引用转化(Deref coercion) 是为函数和方法提供的一种便捷特性</p></li><li><p>假设T实现了 <code>Deref</code> trait:</p><ul><li>Deref Coercion 可以把T的引用转化为T经过Deref操作后生成的引用</li></ul></li><li><p>当把某类型的引用传递给函数或者方法时, 但它的类型与定义的参数类型不匹配:</p><ul><li>Deref Coercion 就会自动发生</li><li>编译器会对deref进行一系列调用, 来把它转化为所需的参数类型 <ul><li>在编译时完成, 没有额外的性能开销</li></ul></li></ul></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">hello</span><span class="token punctuation">(</span>name <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;hello,{}&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> m <span class="token operator">=</span> <span class="token class-name">MyBox</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Rust&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// &amp;m &amp; MyBox&lt;String&gt;</span></span>
<span class="line">    <span class="token comment">// deref &amp;String</span></span>
<span class="line">    <span class="token comment">// deref &amp;str</span></span>
<span class="line">    <span class="token function">hello</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// equals to </span></span>
<span class="line">    <span class="token function">hello</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">struct</span> <span class="token type-definition class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">MyBox</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">MyBox</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解引用与可变性" tabindex="-1"><a class="header-anchor" href="#解引用与可变性"><span>解引用与可变性</span></a></h3><ul><li>可使用<code>DerefMut</code> trait 来重载可变引用的*运算符 <ul><li>当<code>T: Deref&lt;Target=U&gt;</code> 允许&amp;T转换为&amp;U</li><li>当<code>T: DerefMut&lt;Target=U&gt;</code> 允许&amp;mut T转换为&amp;mut U</li><li>当<code>T: Deref&lt;Target=U&gt;</code> 允许&amp;mut T转换为&amp;U</li></ul></li></ul><h2 id="drop-trait" tabindex="-1"><a class="header-anchor" href="#drop-trait"><span><code>Drop</code> trait</span></a></h2><ul><li><p>实现了 <code>Drop</code> trait 可以让我们自定义当一个值离开作用域时发生的动作</p><ul><li>例如: 文件, 网络资源释放等</li><li>任何类型都可以实现 <code>Drop</code> trait</li></ul></li><li><p><code>Drop</code> trait 只要求你实现 <code>drop</code> 方法</p><ul><li>参数: 对self的可变引用</li></ul></li><li><p><code>Drop</code> trait 在预导入模块里(Prelude)</p></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token type-definition class-name">CustomSmartPointer</span><span class="token punctuation">{</span></span>
<span class="line">    data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">CustomSmartPointer</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping CustomSmartPointer with data`{}`!&quot;</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;my stuff&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;other stuff&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer created&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用std-mem-drop-来提前drop值" tabindex="-1"><a class="header-anchor" href="#使用std-mem-drop-来提前drop值"><span>使用std::mem::drop 来提前drop值</span></a></h3><ul><li>很难直接禁用自动的drop功能, 也没必要 <ul><li>Drop trait 的目的主要是进行自动地释放处理逻辑</li></ul></li><li>Rust 不允许手动调用Drop trait 的drop方法</li><li>但是可以调用标准库的 <code>std::mem::drop</code> 函数来提前释放值</li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;my stuff&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">drop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;other stuff&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer created&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="rc-t-引用计数智能指针" tabindex="-1"><a class="header-anchor" href="#rc-t-引用计数智能指针"><span><code>Rc&lt;T&gt;</code> 引用计数智能指针</span></a></h2><ul><li><p>有时, 一个值会有多个所有者</p><img src="/learning-notes/assets/image-3-CZz06bTh.png" alt="multi-owner" width="250"></li><li><p>为了支持多重所有权: <code>Rc&lt;T&gt;</code></p><ul><li>reference counting (引用计数)</li><li>可以追踪所有到值的引用</li><li>0个引用, 该值可以被清理</li></ul></li></ul><h3 id="rc-t-的使用场景" tabindex="-1"><a class="header-anchor" href="#rc-t-的使用场景"><span><code>Rc&lt;T&gt;</code> 的使用场景</span></a></h3><ul><li>需要在heap上分配数据, 这些数据被程序的多个部分读取(只读), 但在编译时无法确定哪个部分最后使用完这些数据</li><li><code>Rc&lt;T&gt;</code> 只能用于单线程场景</li></ul><h3 id="rc-t-的例子" tabindex="-1"><a class="header-anchor" href="#rc-t-的例子"><span><code>Rc&lt;T&gt;</code> 的例子</span></a></h3><ul><li><p><code>Rc&lt;T&gt;</code> 不在预导入模块(preludez) 中</p></li><li><p>Rc::clone(&amp;a)函数: 会增加引用计数</p></li><li><p>Rc::strong_count(&amp;a)函数: 获得强引用计数</p><ul><li>Rc::weak_count(&amp;a)函数: 获得弱引用计数</li></ul></li><li><p>两个List共享另一个List的所有权</p><img src="/learning-notes/assets/image-4-B1ln5Z69.png" alt="multi-owner" width="250"></li></ul><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rc-clone-vs-clone-方法" tabindex="-1"><a class="header-anchor" href="#rc-clone-vs-clone-方法"><span>Rc::clone vs clone() 方法</span></a></h3><ul><li>Rc::clone(): 增加引用, 不会执行数据的深拷贝操作</li><li>类型的clone() 方法: 很多会执行数据的深拷贝操作</li></ul><h3 id="rc-t" tabindex="-1"><a class="header-anchor" href="#rc-t"><span><code>Rc&lt;T&gt;</code></span></a></h3><ul><li><code>Rc&lt;T&gt;</code> 通过不可变引用, 使你可以在程序的不同部分之间共享只读数据</li></ul><h2 id="refcell-t-和内部可变性-interior-mutability" tabindex="-1"><a class="header-anchor" href="#refcell-t-和内部可变性-interior-mutability"><span><code>RefCell&lt;T&gt;</code> 和内部可变性(Interior mutability)</span></a></h2><ul><li>内部可变性是Rust的设计模式之一</li><li>它允许你在只持有不可变引用的情况下对数据进行修改 <ul><li>数据结构中使用了unsafe代码来绕过Rust正常的可变性和借用规则</li></ul></li></ul><h3 id="refcell-t" tabindex="-1"><a class="header-anchor" href="#refcell-t"><span><code>RefCell&lt;T&gt;</code></span></a></h3><ul><li>与 <code>Rc&lt;T&gt;</code> 不同, <code>RefCell&lt;T&gt;</code> 类型代表了其持有数据的唯一所有权</li></ul><h4 id="复习借用规则" tabindex="-1"><a class="header-anchor" href="#复习借用规则"><span>复习借用规则：</span></a></h4><ul><li>在任何给定的时间里, 你要么只能拥有一个可变引用, 要么只能任意数量的不可变引用</li><li>引用总司有效的</li></ul><h3 id="refcell-t-与box-t-的区别" tabindex="-1"><a class="header-anchor" href="#refcell-t-与box-t-的区别"><span><code>RefCell&lt;T&gt;</code> 与<code>Box&lt;T&gt;</code> 的区别</span></a></h3><ul><li><code>Box&lt;T&gt;</code><ul><li>编译阶段强制代码遵守借用规则</li><li>否则出现错误</li></ul></li><li><code>RefCell&lt;T&gt;</code><ul><li>只会在运行时检查借用规则</li><li>否则触发panic</li></ul></li></ul><h3 id="借用规则在不同阶段检查的比较" tabindex="-1"><a class="header-anchor" href="#借用规则在不同阶段检查的比较"><span>借用规则在不同阶段检查的比较</span></a></h3><ul><li><p>编译阶段:</p><ul><li>尽早暴露问题</li><li>没有任何运行时开销</li><li>对大多数场景是最佳选择</li><li>是Rust的默认行为</li></ul></li><li><p>运行时:</p><ul><li>问题暴露延后, 甚至到生产环境</li><li>因借用计数产生些许性能损失</li><li>实现某些特定的内存安全场景(不可变环境中修改自身数据)</li></ul></li></ul><h3 id="refcell-t-1" tabindex="-1"><a class="header-anchor" href="#refcell-t-1"><span><code>RefCell&lt;T&gt;</code></span></a></h3><ul><li>与 <code>Rc&lt;T&gt;</code> 类似, 只能用于单线程场景</li></ul><h3 id="选择-box-t-rc-t-refcell-t-的依据" tabindex="-1"><a class="header-anchor" href="#选择-box-t-rc-t-refcell-t-的依据"><span>选择 <code>Box&lt;T&gt;</code> <code>Rc&lt;T&gt;</code> <code>RefCell&lt;T&gt;</code>的依据</span></a></h3><img src="/learning-notes/assets/image-5-DGlXOEZB.png" alt="comparison" width="500"><h3 id="内部可变性-可变的借用一个不可变的值" tabindex="-1"><a class="header-anchor" href="#内部可变性-可变的借用一个不可变的值"><span>内部可变性: 可变的借用一个不可变的值</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Messenger</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">&#39;a</span> <span class="token operator">+</span> <span class="token class-name">Messenger</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">T</span><span class="token punctuation">,</span></span>
<span class="line">    value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span></span>
<span class="line">    max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span> <span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token keyword">where</span></span>
<span class="line">    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span> <span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">LimitTracker</span> <span class="token punctuation">{</span></span>
<span class="line">            messenger<span class="token punctuation">,</span></span>
<span class="line">            value<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            max<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">let</span> percentage_of_max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>max <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">1.0</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Error: you are over your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.9</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger</span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Uegent warning: you&#39;ve used up over 90% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.75</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger</span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: You&#39;ve used up over 75% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token attribute attr-name">#[cfg(test)]</span></span>
<span class="line"><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token type-definition class-name">MockMessenger</span> <span class="token punctuation">{</span></span>
<span class="line">        sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">impl</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">MockMessenger</span><span class="token punctuation">{</span></span>
<span class="line">                sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token attribute attr-name">#[test]</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">it_sends_an_over_75_percent_warning_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> mock_messenger <span class="token operator">=</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token keyword">mut</span> limit_tracker <span class="token operator">=</span> <span class="token class-name">LimitTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock_messenger<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        limit_tracker<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>mock_messenger<span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用refcell-t-在运行时记录借用信息" tabindex="-1"><a class="header-anchor" href="#使用refcell-t-在运行时记录借用信息"><span>使用<code>RefCell&lt;T&gt;</code> 在运行时记录借用信息</span></a></h3><ul><li><p>两个方法(安全接口):</p><ul><li>borrow方法: <ul><li>返回智能指针<code>Ref&lt;T&gt;</code>, 它实现了<code>Deref</code> trait</li></ul></li><li>borrow_mut方法: <ul><li>返回智能指针<code>RefMut&lt;T&gt;</code>, 它实现了<code>Deref</code> trait</li></ul></li></ul></li><li><p><code>RefCell&lt;T&gt;</code> 会记录当前存在多少个活跃的<code>Ref&lt;T&gt;</code> 和 <code>RefMut&lt;T&gt;</code> 智能指针</p><ul><li>每次调用borrow: 不可变借用计数加一</li><li>任何一个<code>Ref&lt;T&gt;</code>的值离开作用域被释放时, 不可变借用计数减一</li><li>每次调用borrow_mut: 可变借用计数加一</li><li>任何一个<code>RefMut&lt;T&gt;</code>的值离开作用域被释放时, 可变借用计数减一</li></ul></li><li><p>Rust以此技术来维护借用检查规则:</p><ul><li>任何一个给定时间里, 只允许拥有有多个不可变借用或一个可变借用</li></ul></li></ul><h3 id="使用-rc-t-和-refcell-t-来实现一个拥有多重所有权的可变数据" tabindex="-1"><a class="header-anchor" href="#使用-rc-t-和-refcell-t-来实现一个拥有多重所有权的可变数据"><span>使用 <code>Rc&lt;T&gt;</code> 和 <code>RefCell&lt;T&gt;</code> 来实现一个拥有多重所有权的可变数据</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[derive(Debug)]</span></span>
<span class="line"><span class="token keyword">enum</span> <span class="token type-definition class-name">List</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">,</span> <span class="token namespace">cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token operator">*</span>value<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a after = {:?}&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b after = {:?}&quot;</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;c after = {:?}&quot;</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="其它可实现内部可变性的类型" tabindex="-1"><a class="header-anchor" href="#其它可实现内部可变性的类型"><span>其它可实现内部可变性的类型</span></a></h3><ul><li><code>Cell&lt;T&gt;</code>: 通过复制来访问数据</li><li><code>Mutex&lt;T&gt;</code>: 用于实现跨线程情形下的内部可变性模式</li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: pzh1760473545@gmail.com">pingzhihe</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/learning-notes/rust-learning/Closure.html" aria-label="12.Closure 闭包"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>12.Closure 闭包</span></div></a><a class="route-link auto-link next" href="/learning-notes/rust-learning/Fearless-concurrency.html" aria-label="14.Fearless concurrency 无畏并发"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>14.Fearless concurrency 无畏并发</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/learning-notes/assets/app-DsOgR8nk.js" defer></script>
  </body>
</html>
